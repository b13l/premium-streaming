<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo Premium</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
            background:#0a0a0a;
            color:#d4af37;
            min-height:100vh;
            padding:20px;
        }
        .header { text-align:center; margin-bottom:30px; }
        .header h1 {
            color:#d4af37;
            font-size:2em;
            text-shadow:0 0 20px rgba(212,175,55,0.5);
            margin-bottom:10px;
        }
        .header p { color:#b8860b; }

        .admin-pin {
            background:linear-gradient(135deg,#00ff00 0%,#00cc00 100%);
            color:#0a0a0a;
            padding:20px;
            border-radius:10px;
            text-align:center;
            margin-bottom:20px;
            font-weight:bold;
            font-size:1.2em;
            box-shadow:0 0 20px rgba(0,255,0,0.4);
        }

        .info-box {
            background:rgba(0,212,255,0.1);
            border:2px solid #00d4ff;
            color:#00d4ff;
            padding:15px;
            border-radius:8px;
            margin-bottom:20px;
            text-align:center;
        }

        .tabs {
            display:flex;
            gap:10px;
            margin-bottom:30px;
            flex-wrap:wrap;
        }
        .tab-btn {
            background:rgba(212,175,55,0.1);
            border:2px solid #d4af37;
            color:#d4af37;
            padding:12px 25px;
            border-radius:8px;
            cursor:pointer;
            font-weight:bold;
            transition:all 0.3s;
        }
        .tab-btn:hover { background:#d4af37;color:#0a0a0a; }
        .tab-btn.active {
            background:#d4af37;
            color:#0a0a0a;
            box-shadow:0 0 20px rgba(212,175,55,0.6);
        }

        .tab-content { display:none; }
        .tab-content.active { display:block; }

        .status-bar {
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:20px;
            margin-bottom:30px;
        }
        .status-card {
            background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);
            padding:20px;
            border-radius:10px;
            border:2px solid #d4af37;
            text-align:center;
        }
        .status-card h3 {
            color:#b8860b;
            font-size:0.9em;
            margin-bottom:10px;
        }
        .status-card .number {
            color:#d4af37;
            font-size:2.5em;
            font-weight:bold;
        }

        .services-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
            gap:20px;
        }
        .service-card {
            background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);
            padding:20px;
            border-radius:10px;
            border:2px solid #d4af37;
        }
        .service-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:15px;
            padding-bottom:15px;
            border-bottom:2px solid #d4af37;
        }
        .service-name {
            color:#d4af37;
            font-weight:bold;
            font-size:1.2em;
        }
        .service-count {
            background:#d4af37;
            color:#0a0a0a;
            padding:5px 12px;
            border-radius:15px;
            font-weight:bold;
        }

        .accounts-input {
            background:#0a0a0a;
            border:2px solid #00d4ff;
            color:#00d4ff;
            padding:12px;
            border-radius:8px;
            width:100%;
            margin-bottom:10px;
            font-family:monospace;
            min-height:100px;
            resize:vertical;
        }

        .btn {
            background:linear-gradient(135deg,#d4af37 0%,#f0c843 100%);
            color:#0a0a0a;
            border:none;
            padding:12px 20px;
            border-radius:8px;
            cursor:pointer;
            font-weight:bold;
            transition:all 0.3s;
            width:100%;
        }
        .btn:hover { transform:scale(1.02); }
        .btn-secondary { background:#ff4444;color:#fff; }
        .btn-secondary:hover { background:#ff5555; }
        .btn-delete { background:#ff6b6b;color:#fff;margin-top:10px; }
        .btn-delete:hover { background:#ff7f7f; }

        .btn-group { display:flex; gap:10px; }
        .btn-group .btn { flex:1; }
        .btn-group .btn-delete { margin-top:0; }

        .add-service-section {
            background:rgba(212,175,55,0.1);
            padding:20px;
            border-radius:10px;
            border:2px solid #d4af37;
            margin-bottom:20px;
        }

        .form-group { margin-bottom:15px; }
        .form-group label {
            display:block;
            color:#d4af37;
            margin-bottom:8px;
            font-weight:bold;
        }
        .form-group input {
            width:100%;
            padding:12px;
            background:#0a0a0a;
            border:2px solid #d4af37;
            color:#d4af37;
            border-radius:8px;
            font-size:1em;
        }
        .form-group input:focus {
            outline:none;
            border-color:#f0c843;
            box-shadow:0 0 15px rgba(240,200,67,0.3);
        }

 .purchases-list {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
            gap:20px;
        }
        .purchase-card {
            background:linear-gradient(135deg,#1a3a1a 0%,#2d4d2d 100%);
            padding:20px;
            border-radius:10px;
            border:2px solid #4caf50;
        }
        .purchase-header {
            color:#4caf50;
            font-weight:bold;
            margin-bottom:10px;
            display:flex;
            justify-content:space-between;
        }
        .purchase-info {
            color:#b8860b;
            font-size:0.9em;
            margin-bottom:8px;
        }

        @media (max-width:768px) {
            .status-bar { grid-template-columns:1fr; }
            .services-grid { grid-template-columns:1fr; }
            .tabs { flex-direction:column; }
            .tab-btn { width:100%; }
            .btn-group { flex-direction:column; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>Painel Administrativo Premium</h1>
    <p>Gerencie contas e comprovantes de pagamento</p>
</div>

<div class="admin-pin">
    PIN ATIVO: <strong>633733</strong>
</div>

<div class="info-box">
    Acesso somente ap√≥s aprova√ß√£o manual do comprovante.<br>
    Bloqueie se o comprovante for falso.
</div>

<div id="pendingAlert" class="info-box" style="display:none;border-color:#ffb300;color:#ffb300;">
    Nenhuma compra pendente no momento.
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('contas')">Gerenciar Contas</button>
    <button class="tab-btn" onclick="switchTab('compras')">Compras</button>
</div>

<!-- TAB CONTAS -->
<div id="contas" class="tab-content active">
    <div class="add-service-section">
        <h2 style="color:#d4af37;margin-bottom:15px;">Adicionar Novo Servi√ßo</h2>
        <div class="form-group">
            <label>Nome do Servi√ßo</label>
            <input type="text" id="newServiceName" placeholder="Ex: Apple TV, Paramount, etc">
        </div>
        <div class="form-group">
            <label>Emoji/√çcone</label>
            <input type="text" id="newServiceEmoji" placeholder="Ex: üì∫, üé¨, etc" maxlength="2">
        </div>
        <button class="btn" onclick="addNewService()">Adicionar Servi√ßo</button>
    </div>

    <div class="status-bar" id="statusBar"></div>

    <div class="btn-group" style="margin-bottom:15px;">
        <button class="btn" onclick="moveFirstToLast()">Mover primeiro para o fim</button>
        <button class="btn" onclick="moveLastToFirst()">Mover √∫ltimo para o in√≠cio</button>
    </div>

    <div class="services-grid" id="servicesGrid"></div>
</div>

<!-- TAB COMPRAS -->
<div id="compras" class="tab-content">
    <button class="btn btn-delete" onclick="clearAllPurchases()" style="max-width:250px;margin-bottom:15px;">
        Limpar clientes existentes
    </button>
    <div class="purchases-list" id="purchasesList"></div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ================== SUPABASE CONFIG ==================
const SUPABASE_URL = "https://pyzgoqmfmlmuhwmaoaou.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5emdvcW1mbWxtdWh3bWFvYW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTU3MTYsImV4cCI6MjA4MzY3MTcxNn0.FQfJyo-zxFsAO8wQw6BMTMHL6hOFK4KrbaAebj0p6hU";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ================== FIM SUPABASE CONFIG ==================


// --------- abas ---------
function switchTab(tabName) {
  // esconde todos os conte√∫dos
  document.querySelectorAll(".tab-content").forEach(el => {
    el.classList.remove("active");
  });

  // remove ativo dos bot√µes
  document.querySelectorAll(".tab-btn").forEach(el => {
    el.classList.remove("active");
  });

  // mostra a aba escolhida
  const tabEl = document.getElementById(tabName);
  if (tabEl) tabEl.classList.add("active");

  // ativa bot√£o correspondente
  if (tabName === "contas") {
    document.querySelector('.tab-btn:nth-child(1)')?.classList.add("active");
  } else if (tabName === "compras") {
    document.querySelector('.tab-btn:nth-child(2)')?.classList.add("active");
  }
}



// =========== COMPRAS VIA SUPABASE ===========

async function renderPurchases() {
    const container = document.getElementById("purchasesList");
    if (!container) return;

    // busca todas as compras ordenadas pela data de cria√ß√£o (mais recentes primeiro)
    const { data: purchases, error } = await supabaseClient
        .from("purchases")
        .select("*")
        .order("created_at", { ascending: false });

    if (error) {
        console.error(error);
        container.innerHTML = `<p style="color:#ff6666;grid-column:1/-1;text-align:center;padding:30px;">Erro ao carregar compras.</p>`;
        return;
    }

    const pendingCount = purchases.filter(p => p.status === "pending").length;
    const pendingAlert = document.getElementById("pendingAlert");
    if (pendingAlert) {
        if (pendingCount > 0) {
            pendingAlert.style.display = "block";
            pendingAlert.textContent = `‚ö† Existem ${pendingCount} compra(s) pendente(s) de an√°lise. Abra a aba "Compras".`;
        } else {
            pendingAlert.style.display = "none";
        }
    }

    if (!purchases || purchases.length === 0) {
        container.innerHTML = `<p style="color:#888;grid-column:1/-1;text-align:center;padding:30px;">Nenhuma compra registrada</p>`;
        return;
    }

    container.innerHTML = purchases.map(p => `
        <div class="purchase-card">
            <div class="purchase-header">
                <span>${p.plan_name}</span>
                <span style="color:#4caf50;">${p.pin || "Aguardando PIN"}</span>
            </div>
            <div class="purchase-info">${p.plan_price || ""}</div>
            <div class="purchase-info">Cliente: ${p.payer_name || "‚Äî"}</div>
            <div class="purchase-info">Email: ${p.client_email || "‚Äî"}</div>
            <div class="purchase-info">WhatsApp: ${p.client_whatsapp || "‚Äî"}</div>
            <div class="purchase-info">Data: ${p.purchase_date ? new Date(p.purchase_date).toLocaleString("pt-BR") : "‚Äî"}</div>
            <div class="purchase-info">Expira: ${p.expiry_date ? new Date(p.expiry_date).toLocaleString("pt-BR") : "‚Äî"}</div>
            <div class="purchase-info">
                Status:
                <span style="color:${
                    p.status === "approved" ? "#4caf50" :
                    p.status === "pending"  ? "#ffb300" :
                    "#ff4444"
                };">
                    ${p.status.toUpperCase()}
                </span>
            </div>
            ${
                p.status === "pending"
                  ? `
                    <button class="btn" onclick="approvePurchase('${p.id}')">Aprovar</button>
                    <button class="btn btn-secondary" onclick="rejectPurchase('${p.id}')">Rejeitar</button>
                    `
                  : p.status === "approved"
                  ? `<button class="btn btn-secondary" onclick="blockPurchase('${p.id}')">Bloquear Comprovante Falso</button>`
                  : ""
            }
        </div>
    `).join("");
}

const planDays = {
    "1 M√™s": 30,
    "3 Meses": 90,
    "6 Meses": 180,
    "1 Ano": 365,
    "Vital√≠cio": 36500
};

async function approvePurchase(purchaseId) {
    const { data: purchases, error } = await supabaseClient
        .from("purchases")
        .select("*")
        .eq("id", purchaseId)
        .single();

    if (error || !purchases) {
        alert("Erro ao carregar compra.");
        console.error(error);
        return;
    }

    const p = purchases;

    if (p.status !== "pending") {
        alert("Essa compra j√° foi analisada.");
        return;
    }

    if (!confirm(`Aprovar compra de ${p.payer_name || "cliente"} (${p.plan_name})?`)) return;

    const randomPin = String(Math.floor(Math.random() * 1000000)).padStart(6, "0");
    const now = new Date();
    let daysToAdd = planDays[p.plan_name] || 30;
    const expiryDate = new Date(now.getTime() + daysToAdd * 24 * 60 * 60 * 1000);

    const { error: updError } = await supabaseClient
        .from("purchases")
        .update({
            pin: randomPin,
            status: "approved",
            purchase_date: now.toISOString(),
            expiry_date: expiryDate.toISOString()
        })
        .eq("id", purchaseId);

    if (updError) {
        console.error(updError);
        alert("Erro ao aprovar compra.");
        return;
    }

    await renderPurchases();
    alert(`Compra aprovada! PIN do cliente: ${randomPin}\n\nCopie e envie por email ou WhatsApp.`);
}

async function rejectPurchase(purchaseId) {
    if (!confirm("Rejeitar esta comprova√ß√£o de pagamento?")) return;

    const { error } = await supabaseClient
        .from("purchases")
        .update({ status: "rejected" })
        .eq("id", purchaseId);

    if (error) {
        console.error(error);
        alert("Erro ao rejeitar compra.");
        return;
    }

    await renderPurchases();
}

async function blockPurchase(purchaseId) {
    if (!confirm("Tem certeza que quer bloquear este PIN?")) return;

    const { error } = await supabaseClient
        .from("purchases")
        .update({ status: "blocked" })
        .eq("id", purchaseId);

    if (error) {
        console.error(error);
        alert("Erro ao bloquear compra.");
        return;
    }

    await renderPurchases();
}

async function clearAllPurchases() {
    if (!confirm("Tem certeza que quer limpar todos os clientes existentes?")) return;

    const { error } = await supabaseClient
        .from("purchases")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000"); // truque para deletar todos

    if (error) {
        console.error(error);
        alert("Erro ao limpar compras.");
        return;
    }

    await renderPurchases();
}


// --------- servi√ßos din√¢micos ---------
async function loadAccountsForService(serviceId) {
    const { data, error } = await supabaseClient
        .from("accounts")
        .select("*")
        .eq("service_id", serviceId)
        .order("created_at", { ascending: true });

    if (error) {
        console.error(error);
        return [];
    }
    return data || [];
}

async function loadServicesAndRenderCards() {
    const container = document.getElementById("servicesGrid");
    const statusBar = document.getElementById("statusBar");
    if (!container) return;

    container.innerHTML = `
        <div style="text-align:center;color:#ccc;padding:20px;">
            Carregando servi√ßos...
        </div>
    `;

    const { data: services, error } = await supabaseClient
        .from("services")
        .select("*")
        .order("position", { ascending: true });

    if (error) {
        console.error(error);
        container.innerHTML = `
            <div style="text-align:center;color:#ff6666;padding:20px;">
                Erro ao carregar servi√ßos.
            </div>
        `;
        return;
    }

    if (!services || services.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;color:#ccc;padding:20px;">
                Nenhum servi√ßo cadastrado ainda.
            </div>
        `;
        if (statusBar) statusBar.innerHTML = "";
        return;
    }

    // carrega contas de todos os servi√ßos
    const allAccounts = [];
    for (const service of services) {
        const accs = await loadAccountsForService(service.id);
        service._accounts = accs;
        allAccounts.push(...accs);
    }

    // status
    if (statusBar) {
        const totalAccounts = allAccounts.length;
        const activeServices = services.filter(s => (s._accounts || []).length > 0).length;
        const { data: purchasesData } = await supabaseClient
            .from("purchases")
            .select("id, status");
        const activePurchases = (purchasesData || []).filter(p => p.status === "approved").length;

        statusBar.innerHTML = `
            <div class="status-card">
                <h3>Total de Contas</h3>
                <div class="number">${totalAccounts}</div>
            </div>
            <div class="status-card">
                <h3>Servi√ßos Ativos</h3>
                <div class="number">${activeServices}</div>
            </div>
            <div class="status-card">
                <h3>Compras Ativas</h3>
                <div class="number">${activePurchases}</div>
            </div>
        `;
    }

    // monta cards
    container.innerHTML = "";
    services.forEach(service => {
        const card = document.createElement("div");
        card.className = "service-card";
        card.setAttribute("data-service-id", service.id);

        const emoji = service.emoji || "üì¶";
        const name = service.name || "Sem nome";
        const accounts = service._accounts || [];
        const textareaValue = accounts.map(acc => `${acc.username}:${acc.password}`).join("\n");

        card.innerHTML = `
            <div class="service-header">
                <span class="service-emoji">${emoji}</span>
                <span class="service-name">${name}</span>
                <span class="service-count" data-service-count="${service.id}">${accounts.length}</span>
            </div>
            <textarea class="service-accounts-input"
                      placeholder="Cole as contas aqui (usuario:senha)\nUma conta por linha">${textareaValue}</textarea>
            <div class="service-actions">
                <button class="btn-save" onclick="saveAccountsForService('${service.id}')">Salvar</button>
                <button class="btn-delete" onclick="deleteAccountsForService('${service.id}')">Deletar</button>
            </div>
        `;

        container.appendChild(card);
    });
}

async function saveAccountsForService(serviceId) {
    const card = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (!card) return;

    const textarea = card.querySelector(".service-accounts-input");
    const countSpan = card.querySelector(`[data-service-count="${serviceId}"]`);
    if (!textarea) return;

    const text = textarea.value.trim();
    const { data: serviceRow } = await supabaseClient
        .from("services")
        .select("name, emoji")
        .eq("id", serviceId)
        .maybeSingle();

    const serviceName = serviceRow?.name || "Sem nome";
    const emoji = serviceRow?.emoji || "üì¶";

    const newAccounts = [];
    if (text) {
        const lines = text.split("\n");
        for (let line of lines) {
            line = line.trim();
            if (!line || !line.includes(":")) continue;
            const parts = line.split(":");
            if (parts.length < 2) continue;
            const username = parts[0].trim();
            const password = parts.slice(1).join(":").trim();
            if (username && password) {
                newAccounts.push({
                    service_id: serviceId,
                    service_name: serviceName,
                    emoji,
                    username,
                    password
                });
            }
        }
    }

    const { error: delError } = await supabaseClient
        .from("accounts")
        .delete()
        .eq("service_id", serviceId);

    if (delError) {
        console.error(delError);
        alert("Erro ao limpar contas antigas.");
        return;
    }

    if (newAccounts.length > 0) {
        const { error: insError } = await supabaseClient
            .from("accounts")
            .insert(newAccounts);

        if (insError) {
            console.error(insError);
            alert("Erro ao salvar contas.");
            return;
        }
    }

    if (countSpan) countSpan.textContent = String(newAccounts.length);
    alert(`${newAccounts.length} contas salvas com sucesso!`);
}

async function deleteAccountsForService(serviceId) {
    if (!confirm("Tem certeza que quer deletar ESTE SERVI√áO e todas as contas dele?")) return;

    // 1) apaga contas
    const { error: accError } = await supabaseClient
        .from("accounts")
        .delete()
        .eq("service_id", serviceId);

    if (accError) {
        console.error(accError);
        alert("Erro ao deletar contas.");
        return;
    }

    // 2) apaga o pr√≥prio servi√ßo
    const { error: svcError } = await supabaseClient
        .from("services")
        .delete()
        .eq("id", serviceId);

    if (svcError) {
        console.error(svcError);
        alert("Contas apagadas, mas houve erro ao deletar o servi√ßo.");
        return;
    }

    // 3) atualiza UI
    await loadServicesAndRenderCards();
    alert("Servi√ßo e contas deletados com sucesso!");
}

async function reloadServicesPositions(services) {
    try {
        for (let index = 0; index < services.length; index++) {
            const s = services[index];
            const { error } = await supabaseClient
                .from("services")
                .update({ position: index + 1 })
                .eq("id", s.id);

            if (error) {
                console.error(error);
                alert("Erro ao atualizar ordem dos servi√ßos.");
                return false;
            }
        }
        return true;
    } catch (e) {
        console.error(e);
        alert("Erro ao atualizar ordem dos servi√ßos.");
        return false;
    }
}



async function moveFirstToLast() {
    const { data: services, error } = await supabaseClient
        .from("services")
        .select("*")
        .order("position", { ascending: true });

    if (error || !services || services.length <= 1) return;

    const first = services.shift();
    services.push(first);

    const ok = await reloadServicesPositions(services);
    if (ok) await loadServicesAndRenderCards();
}

async function moveLastToFirst() {
    const { data: services, error } = await supabaseClient
        .from("services")
        .select("*")
        .order("position", { ascending: true });

    if (error || !services || services.length <= 1) return;

    const last = services.pop();
    services.unshift(last);

    const ok = await reloadServicesPositions(services);
    if (ok) await loadServicesAndRenderCards();
}


// handler do bot√£o Adicionar Servi√ßo
document.addEventListener("DOMContentLoaded", () => {
    const btnAdd = document.getElementById("btnAddService");
    if (btnAdd) {
        btnAdd.addEventListener("click", addServiceFromForm);
    }
});

async function addServiceFromForm() {
    const nameInput  = document.getElementById("newServiceName");
    const emojiInput = document.getElementById("newServiceEmoji");
    if (!nameInput || !emojiInput) return;

    const name  = nameInput.value.trim();
    const emoji = emojiInput.value.trim() || "üì¶";

    if (!name) {
        alert("Informe o nome do servi√ßo.");
        return;
    }

    // posi√ß√£o: √∫ltimo + 1
    const { data: existing, error: posError } = await supabaseClient
        .from("services")
        .select("position")
        .order("position", { ascending: false })
        .limit(1);

    let nextPos = 1;
    if (!posError && existing && existing.length > 0) {
        nextPos = (existing[0].position || 0) + 1;
    }

    const { error } = await supabaseClient
        .from("services")
        .insert({
            name,
            emoji,
            position: nextPos
        });

    if (error) {
        console.error(error);
        alert("Erro ao adicionar servi√ßo.");
        return;
    }

    nameInput.value = "";
    emojiInput.value = "";
    await loadServicesAndRenderCards();
    alert("Servi√ßo adicionado com sucesso!");
}

document.addEventListener("DOMContentLoaded", () => {
    const btnFirstLast = document.getElementById("btnMoveFirstToLast");
    const btnLastFirst = document.getElementById("btnMoveLastToFirst");

    if (btnFirstLast) {
        btnFirstLast.addEventListener("click", moveFirstToLast);
    }
    if (btnLastFirst) {
        btnLastFirst.addEventListener("click", moveLastToFirst);
    }
});



// --------- inicializa√ß√£o ---------
async function init() {
    await renderPurchases();
    await loadServicesAndRenderCards();
}
window.addEventListener("load", init);

</script>

</body>
</html>
