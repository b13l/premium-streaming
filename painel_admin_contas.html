<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo Premium</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
            background:#0a0a0a;
            color:#d4af37;
            min-height:100vh;
            padding:20px;
        }
        .header { text-align:center; margin-bottom:30px; }
        .header h1 {
            color:#d4af37;
            font-size:2em;
            text-shadow:0 0 20px rgba(212,175,55,0.5);
            margin-bottom:10px;
        }
        .header p { color:#b8860b; }

        .admin-pin {
            background:linear-gradient(135deg,#00ff00 0%,#00cc00 100%);
            color:#0a0a0a;
            padding:20px;
            border-radius:10px;
            text-align:center;
            margin-bottom:20px;
            font-weight:bold;
            font-size:1.2em;
            box-shadow:0 0 20px rgba(0,255,0,0.4);
        }

        .info-box {
            background:rgba(0,212,255,0.1);
            border:2px solid #00d4ff;
            color:#00d4ff;
            padding:15px;
            border-radius:8px;
            margin-bottom:20px;
            text-align:center;
        }

        .tabs {
            display:flex;
            gap:10px;
            margin-bottom:30px;
            flex-wrap:wrap;
        }
        .tab-btn {
            background:rgba(212,175,55,0.1);
            border:2px solid #d4af37;
            color:#d4af37;
            padding:12px 25px;
            border-radius:8px;
            cursor:pointer;
            font-weight:bold;
            transition:all 0.3s;
        }
        .tab-btn:hover { background:#d4af37;color:#0a0a0a; }
        .tab-btn.active {
            background:#d4af37;
            color:#0a0a0a;
            box-shadow:0 0 20px rgba(212,175,55,0.6);
        }

        .tab-content { display:none; }
        .tab-content.active { display:block; }

        .status-bar {
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:20px;
            margin-bottom:30px;
        }
        .status-card {
            background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);
            padding:20px;
            border-radius:10px;
            border:2px solid #d4af37;
            text-align:center;
        }
        .status-card h3 {
            color:#b8860b;
            font-size:0.9em;
            margin-bottom:10px;
        }
        .status-card .number {
            color:#d4af37;
            font-size:2.5em;
            font-weight:bold;
        }

        .services-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
            gap:20px;
        }
        .service-card {
            background:linear-gradient(135deg,#1a1a1a 0%,#2d2d2d 100%);
            padding:20px;
            border-radius:10px;
            border:2px solid #d4af37;
        }
        .service-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:15px;
            padding-bottom:15px;
            border-bottom:2px solid #d4af37;
        }
        .service-name {
            color:#d4af37;
            font-weight:bold;
            font-size:1.2em;
        }
        .service-count {
            background:#d4af37;
            color:#0a0a0a;
            padding:5px 12px;
            border-radius:15px;
            font-weight:bold;
        }

        .accounts-input {
            background:#0a0a0a;
            border:2px solid #00d4ff;
            color:#00d4ff;
            padding:12px;
            border-radius:8px;
            width:100%;
            margin-bottom:10px;
            font-family:monospace;
            min-height:100px;
            resize:vertical;
        }

        .btn {
            background:linear-gradient(135deg,#d4af37 0%,#f0c843 100%);
            color:#0a0a0a;
            border:none;
            padding:12px 20px;
            border-radius:8px;
            cursor:pointer;
            font-weight:bold;
            transition:all 0.3s;
            width:100%;
        }
        .btn:hover { transform:scale(1.02); }
        .btn-secondary { background:#ff4444;color:#fff; }
        .btn-secondary:hover { background:#ff5555; }
        .btn-delete { background:#ff6b6b;color:#fff;margin-top:10px; }
        .btn-delete:hover { background:#ff7f7f; }

        .btn-group { display:flex; gap:10px; }
        .btn-group .btn { flex:1; }
        .btn-group .btn-delete { margin-top:0; }

        .add-service-section {
            background:rgba(212,175,55,0.1);
            padding:20px;
            border-radius:10px;
            border:2px solid #d4af37;
            margin-bottom:20px;
        }

        .form-group { margin-bottom:15px; }
        .form-group label {
            display:block;
            color:#d4af37;
            margin-bottom:8px;
            font-weight:bold;
        }
        .form-group input {
            width:100%;
            padding:12px;
            background:#0a0a0a;
            border:2px solid #d4af37;
            color:#d4af37;
            border-radius:8px;
            font-size:1em;
        }
        .form-group input:focus {
            outline:none;
            border-color:#f0c843;
            box-shadow:0 0 15px rgba(240,200,67,0.3);
        }

        .purchases-list {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
            gap:20px;
        }
        .purchase-card {
            background:linear-gradient(135deg,#1a3a1a 0%,#2d4d2d 100%);
            padding:20px;
            border-radius:10px;
            border:2px solid #4caf50;
        }
        .purchase-header {
            color:#4caf50;
            font-weight:bold;
            margin-bottom:10px;
            display:flex;
            justify-content:space-between;
        }
        .purchase-info {
            color:#b8860b;
            font-size:0.9em;
            margin-bottom:8px;
        }

        @media (max-width:768px) {
            .status-bar { grid-template-columns:1fr; }
            .services-grid { grid-template-columns:1fr; }
            .tabs { flex-direction:column; }
            .tab-btn { width:100%; }
            .btn-group { flex-direction:column; }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>Painel Administrativo Premium</h1>
    <p>Gerencie contas e comprovantes de pagamento</p>
</div>

<div class="admin-pin">
    PIN ATIVO: <strong>633733</strong>
</div>

<div class="info-box">
    Acesso somente ap√≥s aprova√ß√£o manual do comprovante.<br>
    Bloqueie se o comprovante for falso.
</div>

<div id="pendingAlert" class="info-box" style="display:none;border-color:#ffb300;color:#ffb300;">
    Nenhuma compra pendente no momento.
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('contas')">Gerenciar Contas</button>
    <button class="tab-btn" onclick="switchTab('compras')">Compras</button>
</div>

<!-- TAB CONTAS -->
<div id="contas" class="tab-content active">
    <div class="add-service-section">
        <h2 style="color:#d4af37;margin-bottom:15px;">Adicionar Novo Servi√ßo</h2>
        <div class="form-group">
            <label>Nome do Servi√ßo</label>
            <input type="text" id="newServiceName" placeholder="Ex: Apple TV, Paramount, etc">
        </div>
        <div class="form-group">
            <label>Emoji/√çcone</label>
            <input type="text" id="newServiceEmoji" placeholder="Ex: üì∫, üé¨, etc" maxlength="2">
        </div>
        <button class="btn" onclick="addNewService()">Adicionar Servi√ßo</button>
    </div>

    <div class="status-bar" id="statusBar"></div>

    <div class="btn-group" style="margin-bottom:15px;">
        <button class="btn" onclick="moveFirstToLast()">Mover primeiro para o fim</button>
        <button class="btn" onclick="moveLastToFirst()">Mover √∫ltimo para o in√≠cio</button>
    </div>

    <div class="services-grid" id="servicesGrid"></div>
</div>

<!-- TAB COMPRAS -->
<div id="compras" class="tab-content">
    <button class="btn btn-delete" onclick="clearAllPurchases()" style="max-width:250px;margin-bottom:15px;">
        Limpar clientes existentes
    </button>
    <div class="purchases-list" id="purchasesList"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ================== SUPABASE CONFIG ==================
const SUPABASE_URL = "https://pyzgoqmfmlmuhwmaoaou.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5emdvcW1mbWxtdWh3bWFvYW91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTU3MTYsImV4cCI6MjA4MzY3MTcxNn0.FQfJyo-zxFsAO8wQw6BMTMHL6hOFK4KrbaAebj0p6hU";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ================== FIM SUPABASE CONFIG ==================
</script>

<script>
let services = [
    { id:1, name:"Claro TV",   emoji:"üì∫", accounts:[] },
    { id:2, name:"Globo Play", emoji:"üì∫", accounts:[] },
    { id:3, name:"Sky",        emoji:"üì°", accounts:[] },
    { id:4, name:"HBO Max",    emoji:"üé¨", accounts:[] },
    { id:5, name:"Disney",     emoji:"üßö", accounts:[] },
    { id:6, name:"Prime Video",emoji:"üì¶", accounts:[] },
    { id:7, name:"testeeee",emoji:"üì¶", accounts:[] },
];

async function init() {
    await renderServices();
    await renderPurchases(); // j√° est√° usando Supabase
}

window.addEventListener("load", init);


function switchTab(tabName) {
    document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
    document.getElementById(tabName).classList.add("active");
    event.target.classList.add("active");
}


function addNewService() {
    const name = document.getElementById("newServiceName").value.trim();
    const emoji = document.getElementById("newServiceEmoji").value.trim();
       if (!name || !emoji) {
        alert("Preencha nome e emoji!");
        return;
    }
    const newId = Math.max(...services.map(s => s.id), 0) + 1;
    services.push({ id:newId, name, emoji, accounts:[] });
    document.getElementById("newServiceName").value = "";
    document.getElementById("newServiceEmoji").value = "";
    renderServices();
    alert("Servi√ßo adicionado com sucesso!");
}

function moveFirstToLast() {
    if (services.length <= 1) return;
    const first = services.shift();
    services.push(first);
    renderServices();
}
function moveLastToFirst() {
    if (services.length <= 1) return;
    const last = services.pop();
    services.unshift(last);
    renderServices();
}

// Carrega contas do Supabase e organiza por servi√ßo
async function loadAccountsFromSupabase() {
    const { data, error } = await supabaseClient
        .from("accounts")
        .select("*")
        .order("service_name", { ascending: true });

    if (error) {
        console.error(error);
        return [];
    }

    return data || [];
}

async function renderServices() {
    const grid = document.getElementById("servicesGrid");
    const statusBar = document.getElementById("statusBar");
    if (!grid || !statusBar) return;

    // busca todas as contas no Supabase
    const accounts = await loadAccountsFromSupabase();

    // descobre servi√ßos distintos a partir das contas + base fixa
    const serviceMap = new Map();

    // se voc√™ quiser manter uma lista fixa de servi√ßos:
    const baseServices = [
        { name: "Claro TV", emoji: "üì∫" },
        { name: "Globo Play", emoji: "üì∫" },
        { name: "Sky", emoji: "üì°" },
        { name: "HBO Max", emoji: "üé¨" },
        { name: "Disney", emoji: "üßö" },
        { name: "Prime Video", emoji: "üì¶" },
        { name: "testeeee", emoji: "üì¶" },

    ];

    baseServices.forEach(s => {
      if (!serviceMap.has(s.name)) {
        serviceMap.set(s.name, { name: s.name, emoji: s.emoji, accounts: [] });
      }
    });

    accounts.forEach(acc => {
        if (!serviceMap.has(acc.service_name)) {
            serviceMap.set(acc.service_name, {
                name: acc.service_name,
                emoji: acc.emoji || "üì∫",
                accounts: []
            });
        }
        serviceMap.get(acc.service_name).accounts.push(acc);
    });

    const servicesList = Array.from(serviceMap.values());

    const totalAccounts = accounts.length;
    const activeServices = servicesList.filter(s => s.accounts.length > 0).length;

    // atualiza status
    const { data: purchasesData } = await supabaseClient
        .from("purchases")
        .select("id, status");

    const activePurchases = (purchasesData || []).filter(p => p.status === "approved").length;

    statusBar.innerHTML = `
        <div class="status-card">
            <h3>Total de Contas</h3>
            <div class="number">${totalAccounts}</div>
        </div>
        <div class="status-card">
            <h3>Servi√ßos Ativos</h3>
            <div class="number">${activeServices}</div>
        </div>
        <div class="status-card">
            <h3>Compras Ativas</h3>
            <div class="number" id="activePurchases">${activePurchases}</div>
        </div>`;

    // monta cards
    grid.innerHTML = "";
    servicesList.forEach(service => {
        const card = document.createElement("div");
        card.className = "service-card";

        const textareaValue = service.accounts
            .map(a => `${a.username}:${a.password}`)
            .join("\n");

        card.innerHTML = `
            <div class="service-header">
                <span>
                    <span style="font-size:1.5em;margin-right:10px;">${service.emoji}</span>
                    <span class="service-name">${service.name}</span>
                </span>
                <span class="service-count">${service.accounts.length}</span>
            </div>
            <textarea class="accounts-input"
                      data-service-name="${service.name}"
                      data-service-emoji="${service.emoji}"
                      placeholder="Cole as contas aqui (usuario:senha)\nUma conta por linha">${textareaValue}</textarea>
            <div class="btn-group">
                <button class="btn" onclick="saveServiceAccounts('${service.name}')">Salvar</button>
                <button class="btn btn-delete" onclick="deleteService('${service.name}')">Deletar</button>
            </div>`;
        grid.appendChild(card);
    });
}


async function saveServiceAccounts(serviceName) {
    const textarea = document.querySelector(`textarea[data-service-name="${serviceName}"]`);
    if (!textarea) return;

    const emoji = textarea.getAttribute("data-service-emoji") || "üì∫";
    const text = textarea.value.trim();

    const newAccounts = [];
    if (text) {
        const lines = text.split("\n");
        lines.forEach(line => {
            line = line.trim();
            if (!line || !line.includes(":")) return;
            const parts = line.split(":");
            if (parts.length < 2) return;
            const username = parts[0].trim();
            const password = parts.slice(1).join(":").trim();
            if (username && password) {
                newAccounts.push({
                    service_name: serviceName,
                    emoji,
                    username,
                    password
                });
            }
        });
    }

    // apaga contas antigas desse servi√ßo
    const { error: delError } = await supabaseClient
        .from("accounts")
        .delete()
        .eq("service_name", serviceName);

    if (delError) {
        console.error(delError);
        alert("Erro ao limpar contas antigas.");
        return;
    }

    // insere novas contas (se tiver)
    if (newAccounts.length > 0) {
        const { error: insError } = await supabaseClient
            .from("accounts")
            .insert(newAccounts);

        if (insError) {
            console.error(insError);
            alert("Erro ao salvar contas.");
            return;
        }
    }

    alert(`${newAccounts.length} contas salvas com sucesso!`);
    await renderServices();
}


async function deleteService(serviceName) {
    if (!confirm(`Tem certeza que quer deletar todas as contas de ${serviceName}?`)) return;

    const { error } = await supabaseClient
        .from("accounts")
        .delete()
        .eq("service_name", serviceName);

    if (error) {
        console.error(error);
        alert("Erro ao deletar servi√ßo.");
        return;
    }

    alert("Servi√ßo deletado com sucesso!");
    await renderServices();
}


// =========== COMPRAS VIA SUPABASE ===========

async function renderPurchases() {
    const container = document.getElementById("purchasesList");
    if (!container) return;

    // busca todas as compras ordenadas pela data de cria√ß√£o (mais recentes primeiro)
    const { data: purchases, error } = await supabaseClient
        .from("purchases")
        .select("*")
        .order("created_at", { ascending: false });

    if (error) {
        console.error(error);
        container.innerHTML = `<p style="color:#ff6666;grid-column:1/-1;text-align:center;padding:30px;">Erro ao carregar compras.</p>`;
        return;
    }

    const pendingCount = purchases.filter(p => p.status === "pending").length;
    const pendingAlert = document.getElementById("pendingAlert");
    if (pendingAlert) {
        if (pendingCount > 0) {
            pendingAlert.style.display = "block";
            pendingAlert.textContent = `‚ö† Existem ${pendingCount} compra(s) pendente(s) de an√°lise. Abra a aba "Compras".`;
        } else {
            pendingAlert.style.display = "none";
        }
    }

    if (!purchases || purchases.length === 0) {
        container.innerHTML = `<p style="color:#888;grid-column:1/-1;text-align:center;padding:30px;">Nenhuma compra registrada</p>`;
        return;
    }

    container.innerHTML = purchases.map(p => `
        <div class="purchase-card">
            <div class="purchase-header">
                <span>${p.plan_name}</span>
                <span style="color:#4caf50;">${p.pin || "Aguardando PIN"}</span>
            </div>
            <div class="purchase-info">${p.plan_price || ""}</div>
            <div class="purchase-info">Cliente: ${p.payer_name || "‚Äî"}</div>
            <div class="purchase-info">Email: ${p.client_email || "‚Äî"}</div>
            <div class="purchase-info">WhatsApp: ${p.client_whatsapp || "‚Äî"}</div>
            <div class="purchase-info">Data: ${p.purchase_date ? new Date(p.purchase_date).toLocaleString("pt-BR") : "‚Äî"}</div>
            <div class="purchase-info">Expira: ${p.expiry_date ? new Date(p.expiry_date).toLocaleString("pt-BR") : "‚Äî"}</div>
            <div class="purchase-info">
                Status:
                <span style="color:${
                    p.status === "approved" ? "#4caf50" :
                    p.status === "pending"  ? "#ffb300" :
                    "#ff4444"
                };">
                    ${p.status.toUpperCase()}
                </span>
            </div>
            ${
                p.status === "pending"
                  ? `
                    <button class="btn" onclick="approvePurchase('${p.id}')">Aprovar</button>
                    <button class="btn btn-secondary" onclick="rejectPurchase('${p.id}')">Rejeitar</button>
                    `
                  : p.status === "approved"
                  ? `<button class="btn btn-secondary" onclick="blockPurchase('${p.id}')">Bloquear Comprovante Falso</button>`
                  : ""
            }
        </div>
    `).join("");
}

const planDays = {
    "1 M√™s": 30,
    "3 Meses": 90,
    "6 Meses": 180,
    "1 Ano": 365,
    "Vital√≠cio": 36500
};

async function approvePurchase(purchaseId) {
    const { data: purchases, error } = await supabaseClient
        .from("purchases")
        .select("*")
        .eq("id", purchaseId)
        .single();

    if (error || !purchases) {
        alert("Erro ao carregar compra.");
        console.error(error);
        return;
    }

    const p = purchases;

    if (p.status !== "pending") {
        alert("Essa compra j√° foi analisada.");
        return;
    }

    if (!confirm(`Aprovar compra de ${p.payer_name || "cliente"} (${p.plan_name})?`)) return;

    const randomPin = String(Math.floor(Math.random() * 1000000)).padStart(6, "0");
    const now = new Date();
    let daysToAdd = planDays[p.plan_name] || 30;
    const expiryDate = new Date(now.getTime() + daysToAdd * 24 * 60 * 60 * 1000);

    const { error: updError } = await supabaseClient
        .from("purchases")
        .update({
            pin: randomPin,
            status: "approved",
            purchase_date: now.toISOString(),
            expiry_date: expiryDate.toISOString()
        })
        .eq("id", purchaseId);

    if (updError) {
        console.error(updError);
        alert("Erro ao aprovar compra.");
        return;
    }

    await renderPurchases();
    alert(`Compra aprovada! PIN do cliente: ${randomPin}\n\nCopie e envie por email ou WhatsApp.`);
}

async function rejectPurchase(purchaseId) {
    if (!confirm("Rejeitar esta comprova√ß√£o de pagamento?")) return;

    const { error } = await supabaseClient
        .from("purchases")
        .update({ status: "rejected" })
        .eq("id", purchaseId);

    if (error) {
        console.error(error);
        alert("Erro ao rejeitar compra.");
        return;
    }

    await renderPurchases();
}

async function blockPurchase(purchaseId) {
    if (!confirm("Tem certeza que quer bloquear este PIN?")) return;

    const { error } = await supabaseClient
        .from("purchases")
        .update({ status: "blocked" })
        .eq("id", purchaseId);

    if (error) {
        console.error(error);
        alert("Erro ao bloquear compra.");
        return;
    }

    await renderPurchases();
}

async function clearAllPurchases() {
    if (!confirm("Tem certeza que quer limpar todos os clientes existentes?")) return;

    const { error } = await supabaseClient
        .from("purchases")
        .delete()
        .neq("id", "00000000-0000-0000-0000-000000000000"); // truque para deletar todos

    if (error) {
        console.error(error);
        alert("Erro ao limpar compras.");
        return;
    }

    await renderPurchases();
}
// =========== FIM COMPRAS VIA SUPABASE ===========


init();
</script>
</body>
</html>
